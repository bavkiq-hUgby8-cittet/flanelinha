<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Flanelinha</title>
    
    <!-- Leaflet CSS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-orange: #FF6B00;
            --dark-orange: #E55A00;
            --light-orange: #FFA500;
            --dark-gray: #333333;
            --medium-gray: #666666;
            --light-gray: #F5F5F5;
            --white: #FFFFFF;
            --success: #4CAF50;
            --warning: #FFC107;
            --danger: #F44336;
            --info: #2196F3;
            --shadow: rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--light-gray);
            color: var(--dark-gray);
        }
        
        /* Layout */
        .dashboard-container {
            display: flex;
            height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--white);
            box-shadow: 2px 0 10px var(--shadow);
            display: flex;
            flex-direction: column;
            transition: width 0.3s;
        }
        
        .sidebar.collapsed {
            width: 70px;
        }
        
        .sidebar-header {
            padding: 1.5rem;
            background: var(--primary-orange);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: white;
            color: var(--primary-orange);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .sidebar.collapsed .logo-text {
            display: none;
        }
        
        .toggle-sidebar {
            background: none;
            border: none;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
        }
        
        /* Navigation */
        .nav-menu {
            flex: 1;
            padding: 1rem 0;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: var(--dark-gray);
            text-decoration: none;
            transition: all 0.3s;
            position: relative;
        }
        
        .nav-item:hover {
            background: var(--light-gray);
            color: var(--primary-orange);
        }
        
        .nav-item.active {
            background: rgba(255, 107, 0, 0.1);
            color: var(--primary-orange);
        }
        
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--primary-orange);
        }
        
        .nav-icon {
            font-size: 1.25rem;
            width: 40px;
            text-align: center;
        }
        
        .sidebar.collapsed .nav-text {
            display: none;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Header */
        .header {
            background: var(--white);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .search-bar {
            display: flex;
            align-items: center;
            background: var(--light-gray);
            border-radius: 50px;
            padding: 0.5rem 1.5rem;
            width: 400px;
        }
        
        .search-bar input {
            background: none;
            border: none;
            outline: none;
            flex: 1;
            margin-left: 0.5rem;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .notification-btn {
            background: none;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            position: relative;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50px;
            transition: background 0.3s;
        }
        
        .user-menu:hover {
            background: var(--light-gray);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-orange);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        /* Content Area */
        .content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--shadow);
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .stat-icon.orange { background: rgba(255, 107, 0, 0.1); color: var(--primary-orange); }
        .stat-icon.green { background: rgba(76, 175, 80, 0.1); color: var(--success); }
        .stat-icon.blue { background: rgba(33, 150, 243, 0.1); color: var(--info); }
        .stat-icon.yellow { background: rgba(255, 193, 7, 0.1); color: var(--warning); }
        
        .stat-info h3 {
            font-size: 0.875rem;
            color: var(--medium-gray);
            margin-bottom: 0.25rem;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--dark-gray);
        }
        
        /* Filters */
        .filters-section {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--shadow);
            margin-bottom: 2rem;
        }
        
        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--medium-gray);
        }
        
        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: var(--white);
        }
        
        /* View Toggle */
        .view-toggle {
            display: flex;
            gap: 0.5rem;
        }
        
        .view-btn {
            padding: 0.5rem 1rem;
            background: var(--light-gray);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .view-btn.active {
            background: var(--primary-orange);
            color: white;
        }
        
        /* Map Container */
        .map-container {
            background: var(--white);
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--shadow);
            height: 500px;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .map-legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--shadow);
            z-index: 1000;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .legend-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        
        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .guard-card {
            background: var(--white);
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--shadow);
            overflow: hidden;
            transition: transform 0.3s;
        }
        
        .guard-card:hover {
            transform: translateY(-5px);
        }
        
        .guard-header {
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .guard-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-orange);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .guard-info h3 {
            margin-bottom: 0.25rem;
        }
        
        .guard-rating {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--warning);
        }
        
        .guard-stats {
            padding: 1rem 1.5rem;
            background: var(--light-gray);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            text-align: center;
        }
        
        .guard-stat-value {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--dark-gray);
        }
        
        .guard-stat-label {
            font-size: 0.75rem;
            color: var(--medium-gray);
        }
        
        .guard-actions {
            padding: 1rem 1.5rem;
            display: flex;
            gap: 0.5rem;
        }
        
        .btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: var(--primary-orange);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--dark-orange);
        }
        
        .btn-secondary {
            background: var(--light-gray);
            color: var(--dark-gray);
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        /* Table View */
        .table-container {
            background: var(--white);
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--shadow);
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: var(--light-gray);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        td {
            padding: 1rem;
            border-bottom: 1px solid var(--light-gray);
        }
        
        tr:hover {
            background: rgba(255, 107, 0, 0.05);
        }
        
        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-active {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success);
        }
        
        .status-inactive {
            background: rgba(244, 67, 54, 0.1);
            color: var(--danger);
        }
        
        .status-busy {
            background: rgba(255, 193, 7, 0.1);
            color: var(--warning);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--white);
            padding: 2rem;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--medium-gray);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -260px;
                z-index: 1500;
                transition: left 0.3s;
            }
            
            .sidebar.mobile-open {
                left: 0;
            }
            
            .search-bar {
                width: auto;
                flex: 1;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Section Card */
        .section-card {
            background: var(--white);
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--shadow);
        }
        
        .section-card h2 {
            margin-bottom: 1.5rem;
            color: var(--dark-gray);
        }
        
        /* Association Card */
        .association-card {
            border: 1px solid var(--light-gray);
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .association-info h3 {
            margin-bottom: 0.5rem;
        }
        
        .association-info p {
            color: var(--medium-gray);
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }
        
        .association-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        /* QR Code Container */
        #myQRCode {
            display: inline-block;
            padding: 2rem;
            background: white;
            border: 2px solid var(--primary-orange);
            border-radius: 10px;
        }
        
        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--light-gray);
            border-top-color: var(--primary-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">F</div>
                    <span class="logo-text">Flanelinha</span>
                </div>
                <button class="toggle-sidebar" onclick="toggleSidebar()">☰</button>
            </div>
            
            <nav class="nav-menu">
                <!-- Admin Menu -->
                <div id="adminMenu" style="display: none;">
                    <a href="#dashboard" class="nav-item active">
                        <span class="nav-icon">📊</span>
                        <span class="nav-text">Dashboard</span>
                    </a>
                    <a href="#associations" class="nav-item">
                        <span class="nav-icon">🏢</span>
                        <span class="nav-text">Associações</span>
                    </a>
                    <a href="#guards" class="nav-item">
                        <span class="nav-icon">👥</span>
                        <span class="nav-text">Guardadores</span>
                    </a>
                    <a href="#spots" class="nav-item">
                        <span class="nav-icon">🚗</span>
                        <span class="nav-text">Vagas Ativas</span>
                    </a>
                    <a href="#financial" class="nav-item">
                        <span class="nav-icon">💰</span>
                        <span class="nav-text">Financeiro</span>
                    </a>
                    <a href="#settings" class="nav-item">
                        <span class="nav-icon">⚙️</span>
                        <span class="nav-text">Configurações</span>
                    </a>
                </div>
                
                <!-- Association Menu -->
                <div id="associationMenu" style="display: none;">
                    <a href="#dashboard" class="nav-item active">
                        <span class="nav-icon">📊</span>
                        <span class="nav-text">Dashboard</span>
                    </a>
                    <a href="#my-guards" class="nav-item">
                        <span class="nav-icon">👥</span>
                        <span class="nav-text">Meus Guardadores</span>
                    </a>
                    <a href="#active-spots" class="nav-item">
                        <span class="nav-icon">🚗</span>
                        <span class="nav-text">Vagas Ativas</span>
                    </a>
                    <a href="#reports" class="nav-item">
                        <span class="nav-icon">📈</span>
                        <span class="nav-text">Relatórios</span>
                    </a>
                    <a href="#financial" class="nav-item">
                        <span class="nav-icon">💰</span>
                        <span class="nav-text">Financeiro</span>
                    </a>
                </div>
                
                <!-- Guard Menu -->
                <div id="guardMenu" style="display: none;">
                    <a href="#my-profile" class="nav-item active">
                        <span class="nav-icon">👤</span>
                        <span class="nav-text">Meu Perfil</span>
                    </a>
                    <a href="#my-qrcode" class="nav-item">
                        <span class="nav-icon">📱</span>
                        <span class="nav-text">Meu QR Code</span>
                    </a>
                    <a href="#my-spots" class="nav-item">
                        <span class="nav-icon">🚗</span>
                        <span class="nav-text">Minhas Vagas</span>
                    </a>
                    <a href="#my-earnings" class="nav-item">
                        <span class="nav-icon">💰</span>
                        <span class="nav-text">Meus Ganhos</span>
                    </a>
                    <a href="#my-ratings" class="nav-item">
                        <span class="nav-icon">⭐</span>
                        <span class="nav-text">Avaliações</span>
                    </a>
                </div>
            </nav>
            
            <div class="sidebar-footer" style="padding: 1rem;">
                <button onclick="logout()" class="btn btn-secondary" style="width: 100%;">
                    <span class="nav-icon">🚪</span>
                    <span class="nav-text">Sair</span>
                </button>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="search-bar">
                    <span>🔍</span>
                    <input type="text" placeholder="Buscar guardador, associação, CPF..." id="globalSearch">
                </div>
                
                <div class="header-actions">
                    <button class="notification-btn">
                        🔔
                        <span class="notification-badge">3</span>
                    </button>
                    
                    <div class="user-menu">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <div>
                            <div id="userName" style="font-weight: 500;">Carregando...</div>
                            <div id="userRole" style="font-size: 0.875rem; color: var(--medium-gray);">...</div>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Content -->
            <div class="content">
                <!-- Admin Content -->
                <div id="adminContent" style="display: none;">
                    <!-- Stats Cards -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon orange">🏢</div>
                            <div class="stat-info">
                                <h3>Associações Ativas</h3>
                                <div class="stat-value" id="activeAssociationsCount">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon green">👥</div>
                            <div class="stat-info">
                                <h3>Total de Guardadores</h3>
                                <div class="stat-value" id="totalGuardsCount">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon blue">🚗</div>
                            <div class="stat-info">
                                <h3>Vagas Ativas Agora</h3>
                                <div class="stat-value" id="activeSpotsCount">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon yellow">💰</div>
                            <div class="stat-info">
                                <h3>Faturamento Hoje</h3>
                                <div class="stat-value" id="todayRevenue">R$ 0,00</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pending Associations -->
                    <div class="section-card" style="margin-top: 2rem;">
                        <h2>Associações Pendentes de Aprovação</h2>
                        <div id="pendingAssociations">
                            <div class="loading">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Active Associations -->
                    <div class="section-card" style="margin-top: 2rem;">
                        <h2>Associações Ativas</h2>
                        <div id="activeAssociations">
                            <div class="loading">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Association Content -->
                <div id="associationContent" style="display: none;">
                    <!-- Stats Cards -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon orange">👥</div>
                            <div class="stat-info">
                                <h3>Meus Guardadores</h3>
                                <div class="stat-value" id="myGuardsCount">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon green">🚗</div>
                            <div class="stat-info">
                                <h3>Vagas Ativas</h3>
                                <div class="stat-value" id="myActiveSpotsCount">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon blue">💰</div>
                            <div class="stat-info">
                                <h3>Faturamento Hoje</h3>
                                <div class="stat-value" id="myTodayRevenue">R$ 0,00</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon yellow">⭐</div>
                            <div class="stat-info">
                                <h3>Avaliação Média</h3>
                                <div class="stat-value" id="myAvgRating">4.8</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add Guard Form -->
                    <div class="section-card" style="margin-top: 2rem;">
                        <h2>Cadastrar Novo Guardador</h2>
                        <form id="addGuardForm" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <input type="text" placeholder="Nome completo" required>
                            <input type="text" placeholder="CPF" required>
                            <input type="tel" placeholder="WhatsApp" required>
                            <input type="text" placeholder="Área de atuação" required>
                            <input type="email" placeholder="Email (opcional)">
                            <input type="text" placeholder="Chave PIX" required>
                            <button type="submit" class="btn btn-primary">Cadastrar Guardador</button>
                        </form>
                    </div>
                    
                    <!-- My Guards List -->
                    <div class="section-card" style="margin-top: 2rem;">
                        <h2>Meus Guardadores</h2>
                        <div id="myGuardsList">
                            <div class="loading">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Guard Content -->
                <div id="guardContent" style="display: none;">
                    <!-- My QR Code -->
                    <div class="section-card">
                        <h2>Meu QR Code</h2>
                        <div style="text-align: center; padding: 2rem;">
                            <div id="myQRCode"></div>
                            <p style="margin-top: 1rem;">Mostre este QR Code para os clientes</p>
                            <button class="btn btn-primary" onclick="printQRCode()">Imprimir QR Code</button>
                        </div>
                    </div>
                    
                    <!-- Stats -->
                    <div class="stats-grid" style="margin-top: 2rem;">
                        <div class="stat-card">
                            <div class="stat-icon green">🚗</div>
                            <div class="stat-info">
                                <h3>Vagas Hoje</h3>
                                <div class="stat-value" id="mySpotsToday">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon blue">💰</div>
                            <div class="stat-info">
                                <h3>Ganhos Hoje</h3>
                                <div class="stat-value" id="myEarningsToday">R$ 0,00</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon yellow">⭐</div>
                            <div class="stat-info">
                                <h3>Minha Avaliação</h3>
                                <div class="stat-value" id="myRating">5.0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon orange">💸</div>
                            <div class="stat-info">
                                <h3>Gorjetas Hoje</h3>
                                <div class="stat-value" id="myTipsToday">R$ 0,00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Guard Details Modal -->
    <div id="guardModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detalhes do Guardador</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, where, onSnapshot, doc, getDoc, addDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBIRb8Y7ct6wBxeMQ86foRT1s3E2FC8QVY",
            authDomain: "flanelinha-ltda.firebaseapp.com",
            projectId: "flanelinha-ltda",
            storageBucket: "flanelinha-ltda.firebasestorage.app",
            messagingSenderId: "396982431821",
            appId: "1:396982431821:web:9ea195cea51d79b13bac04",
            measurementId: "G-3PPDZZGSDR"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Global variables
        let currentUser = null;
        let userRole = null;
        let map = null;
        let markers = [];
        let guards = [];
        let spots = [];
        
        // Initialize
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData();
                initializeDashboard();
            } else {
                // Fix for GitHub Pages
                const currentPath = window.location.pathname;
                const basePath = currentPath.substring(0, currentPath.lastIndexOf('/'));
                window.location.href = basePath + '/index.html';
            }
        });
        
        // Load user data and determine role
        async function loadUserData() {
            try {
                // Check if admin
                if (currentUser.email === 'admin@flanelinha.com.br') {
                    userRole = 'admin';
                    document.getElementById('adminMenu').style.display = 'block';
                    document.getElementById('userName').textContent = 'Administrador';
                    document.getElementById('userRole').textContent = 'Admin Master';
                    document.getElementById('userAvatar').textContent = 'A';
                    return;
                }
                
                // Check if association
                const assocQuery = query(collection(db, 'associations'), where('email', '==', currentUser.email));
                const assocSnapshot = await getDocs(assocQuery);
                
                if (!assocSnapshot.empty) {
                    const assocData = assocSnapshot.docs[0].data();
                    userRole = 'association';
                    document.getElementById('associationMenu').style.display = 'block';
                    document.getElementById('userName').textContent = assocData.nome;
                    document.getElementById('userRole').textContent = 'Associação';
                    document.getElementById('userAvatar').textContent = assocData.nome[0].toUpperCase();
                    return;
                }
                
                // Check if guard
                const guardQuery = query(collection(db, 'guards'), where('email', '==', currentUser.email));
                const guardSnapshot = await getDocs(guardQuery);
                
                if (!guardSnapshot.empty) {
                    const guardData = guardSnapshot.docs[0].data();
                    userRole = 'guard';
                    document.getElementById('guardMenu').style.display = 'block';
                    document.getElementById('userName').textContent = guardData.name;
                    document.getElementById('userRole').textContent = 'Guardador';
                    document.getElementById('userAvatar').textContent = guardData.name[0].toUpperCase();
                    return;
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }
        
        // Initialize dashboard based on role
        function initializeDashboard() {
            // Hide all content first
            document.getElementById('adminContent').style.display = 'none';
            document.getElementById('associationContent').style.display = 'none';
            document.getElementById('guardContent').style.display = 'none';
            
            // Show content based on role
            switch(userRole) {
                case 'admin':
                    document.getElementById('adminContent').style.display = 'block';
                    loadAdminDashboard();
                    break;
                case 'association':
                    document.getElementById('associationContent').style.display = 'block';
                    loadAssociationDashboard();
                    break;
                case 'guard':
                    document.getElementById('guardContent').style.display = 'block';
                    loadGuardDashboard();
                    break;
            }
        }
        
        // Load admin dashboard
        async function loadAdminDashboard() {
            try {
                // Load pending associations
                const pendingQuery = query(collection(db, 'associacoes_pendentes'), where('status', '==', 'pendente'));
                const pendingSnapshot = await getDocs(pendingQuery);
                
                const pendingDiv = document.getElementById('pendingAssociations');
                if (pendingSnapshot.empty) {
                    pendingDiv.innerHTML = '<p style="text-align: center; color: var(--medium-gray);">Nenhuma associação pendente</p>';
                } else {
                    let html = '';
                    pendingSnapshot.forEach(doc => {
                        const data = doc.data();
                        html += `
                            <div class="association-card">
                                <div class="association-info">
                                    <h3>${data.nome}</h3>
                                    <p>CNPJ: ${data.cnpj}</p>
                                    <p>Responsável: ${data.responsavel}</p>
                                    <p>Email: ${data.email}</p>
                                    <p>WhatsApp: ${data.whatsapp}</p>
                                    <p>Cidade: ${data.cidade}</p>
                                    <p>Guardadores: ${data.quantidadeGuardadores}</p>
                                </div>
                                <div class="association-actions">
                                    <button class="btn btn-primary" onclick="approveAssociation('${doc.id}')">Aprovar</button>
                                    <button class="btn btn-secondary" onclick="rejectAssociation('${doc.id}')">Rejeitar</button>
                                </div>
                            </div>
                        `;
                    });
                    pendingDiv.innerHTML = html;
                }
                
                // Load active associations
                const activeQuery = collection(db, 'associations');
                const activeSnapshot = await getDocs(activeQuery);
                
                const activeDiv = document.getElementById('activeAssociations');
                if (activeSnapshot.empty) {
                    activeDiv.innerHTML = '<p style="text-align: center; color: var(--medium-gray);">Nenhuma associação ativa</p>';
                } else {
                    let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">';
                    activeSnapshot.forEach(doc => {
                        const data = doc.data();
                        html += `
                            <div class="stat-card">
                                <h4>${data.nome}</h4>
                                <p style="color: var(--medium-gray); font-size: 0.875rem;">
                                    CNPJ: ${data.cnpj}<br>
                                    Guardadores: ${data.guardsCount || 0}<br>
                                    Status: <span class="status-badge status-active">Ativa</span>
                                </p>
                            </div>
                        `;
                    });
                    html += '</div>';
                    activeDiv.innerHTML = html;
                }
                
                // Update stats
                document.getElementById('activeAssociationsCount').textContent = activeSnapshot.size;
                
                // Load all guards count
                const guardsSnapshot = await getDocs(collection(db, 'guards'));
                document.getElementById('totalGuardsCount').textContent = guardsSnapshot.size;
                
                // Load active spots
                const spotsQuery = query(collection(db, 'spots'), where('active', '==', true));
                const spotsSnapshot = await getDocs(spotsQuery);
                document.getElementById('activeSpotsCount').textContent = spotsSnapshot.size;
                
                // Calculate today revenue
                let todayRevenue = 0;
                spotsSnapshot.forEach(doc => {
                    const spot = doc.data();
                    todayRevenue += spot.amount || 0;
                });
                document.getElementById('todayRevenue').textContent = `R$ ${todayRevenue.toFixed(2)}`;
                
            } catch (error) {
                console.error('Error loading admin dashboard:', error);
            }
        }
        
        // Load association dashboard
        async function loadAssociationDashboard() {
            try {
                // Get association data
                const assocQuery = query(collection(db, 'associations'), where('email', '==', currentUser.email));
                const assocSnapshot = await getDocs(assocQuery);
                
                if (!assocSnapshot.empty) {
                    const assocDoc = assocSnapshot.docs[0];
                    const assocId = assocDoc.id;
                    const assocData = assocDoc.data();
                    
                    // Load my guards
                    const guardsQuery = query(collection(db, 'guards'), where('associationId', '==', assocId));
                    const guardsSnapshot = await getDocs(guardsQuery);
                    
                    document.getElementById('myGuardsCount').textContent = guardsSnapshot.size;
                    
                    // Display guards list
                    const guardsList = document.getElementById('myGuardsList');
                    if (guardsSnapshot.empty) {
                        guardsList.innerHTML = '<p style="text-align: center; color: var(--medium-gray);">Nenhum guardador cadastrado</p>';
                    } else {
                        let html = '<div class="cards-grid">';
                        guardsSnapshot.forEach(doc => {
                            const guard = doc.data();
                            html += `
                                <div class="guard-card">
                                    <div class="guard-header">
                                        <div class="guard-avatar">${guard.name[0].toUpperCase()}</div>
                                        <div class="guard-info">
                                            <h3>${guard.name}</h3>
                                            <p>CPF: ${formatCPF(guard.cpf)}</p>
                                            <p>WhatsApp: ${guard.phone}</p>
                                        </div>
                                    </div>
                                    <div class="guard-actions">
                                        <button class="btn btn-primary" onclick="showGuardQR('${doc.id}')">Ver QR Code</button>
                                        <button class="btn btn-secondary" onclick="editGuard('${doc.id}')">Editar</button>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                        guardsList.innerHTML = html;
                    }
                    
                    // Setup add guard form
                    document.getElementById('addGuardForm').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        
                        const guardData = {
                            name: e.target[0].value,
                            cpf: e.target[1].value.replace(/\D/g, ''),
                            phone: e.target[2].value,
                            area: e.target[3].value,
                            email: e.target[4].value || `${e.target[1].value.replace(/\D/g, '')}@flanelinha.com.br`,
                            pix: e.target[5].value,
                            associationId: assocId,
                            associationName: assocData.nome,
                            rating: 5.0,
                            createdAt: serverTimestamp()
                        };
                        
                        try {
                            await addDoc(collection(db, 'guards'), guardData);
                            alert('Guardador cadastrado com sucesso!');
                            e.target.reset();
                            loadAssociationDashboard();
                        } catch (error) {
                            alert('Erro ao cadastrar guardador: ' + error.message);
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading association dashboard:', error);
            }
        }
        
        // Load guard dashboard
        async function loadGuardDashboard() {
            try {
                // Get guard data
                const guardQuery = query(collection(db, 'guards'), where('email', '==', currentUser.email));
                const guardSnapshot = await getDocs(guardQuery);
                
                if (!guardSnapshot.empty) {
                    const guardDoc = guardSnapshot.docs[0];
                    const guardId = guardDoc.id;
                    const guardData = guardDoc.data();
                    
                    // Generate QR Code
                    const qrContainer = document.getElementById('myQRCode');
                    qrContainer.innerHTML = ''; // Clear previous QR
                    
                    // QR Code data
                    const qrData = {
                        guardId: guardId,
                        guardName: guardData.name,
                        association: guardData.associationName
                    };
                    
                    // WhatsApp link with guard info
                    const whatsappNumber = '5598970173223';
                    const message = `VAGA:${guardId}|${guardData.name}|${guardData.associationName}`;
                    const whatsappLink = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
                    
                    // Generate QR Code
                    new QRCode(qrContainer, {
                        text: whatsappLink,
                        width: 256,
                        height: 256,
                        colorDark: "#FF6B00",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                    
                    // Load guard stats
                    // This would be real data from spots collection
                    document.getElementById('mySpotsToday').textContent = '0';
                    document.getElementById('myEarningsToday').textContent = 'R$ 0,00';
                    document.getElementById('myRating').textContent = guardData.rating || '5.0';
                    document.getElementById('myTipsToday').textContent = 'R$ 0,00';
                }
            } catch (error) {
                console.error('Error loading guard dashboard:', error);
            }
        }
        
        // Initialize map
        function initializeMap() {
            // Default to Belém coordinates
            map = L.map('map').setView([-1.4558, -48.4902], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Try to get user location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    map.setView([position.coords.latitude, position.coords.longitude], 13);
                });
            }
        }
        
        // Load guards
        async function loadGuards() {
            try {
                let guardsQuery = collection(db, 'guards');
                
                // Filter by association if not admin
                if (userRole === 'association') {
                    // Get association ID and filter guards
                }
                
                const snapshot = await getDocs(guardsQuery);
                guards = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    guards.push({
                        id: doc.id,
                        ...data,
                        status: data.currentSpotId ? 'busy' : 'active',
                        location: data.lastLocation || generateRandomLocation()
                    });
                });
                
                updateMap();
                updateCardsView();
                updateTableView();
            } catch (error) {
                console.error('Error loading guards:', error);
            }
        }
        
        // Load active spots
        async function loadActiveSpots() {
            try {
                const spotsQuery = query(collection(db, 'spots'), where('active', '==', true));
                const snapshot = await getDocs(spotsQuery);
                
                spots = [];
                snapshot.forEach(doc => {
                    spots.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                updateStats();
            } catch (error) {
                console.error('Error loading spots:', error);
            }
        }
        
        // Update map markers
        function updateMap() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Add guard markers
            guards.forEach(guard => {
                if (guard.location) {
                    const color = guard.status === 'busy' ? '#FFC107' : '#4CAF50';
                    const marker = L.circleMarker([guard.location.lat, guard.location.lng], {
                        radius: 10,
                        fillColor: color,
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    
                    marker.bindPopup(`
                        <strong>${guard.name}</strong><br>
                        ${guard.area}<br>
                        Status: ${guard.status === 'busy' ? 'Ocupado' : 'Disponível'}<br>
                        ⭐ ${guard.rating || 5.0}
                    `);
                    
                    markers.push(marker);
                }
            });
            
            // Add spot markers
            spots.forEach(spot => {
                if (spot.location) {
                    const marker = L.marker([spot.location.lat, spot.location.lng], {
                        icon: L.divIcon({
                            html: '🚗',
                            iconSize: [30, 30],
                            className: 'spot-marker'
                        })
                    }).addTo(map);
                    
                    marker.bindPopup(`
                        <strong>Vaga Ativa</strong><br>
                        Cliente: ${spot.clientName}<br>
                        Veículo: ${spot.vehicle}<br>
                        Guardador: ${spot.guardName}
                    `);
                    
                    markers.push(marker);
                }
            });
        }
        
        // Update stats
        function updateStats() {
            document.getElementById('activeGuardsCount').textContent = guards.filter(g => g.status === 'active').length;
            document.getElementById('activeSpotsCount').textContent = spots.length;
            
            // Calculate today's revenue
            const todayRevenue = spots.reduce((total, spot) => total + (spot.amount || 0), 0);
            document.getElementById('todayRevenue').textContent = `R$ ${todayRevenue.toFixed(2)}`;
        }
        
        // Setup realtime listeners
        function setupRealtimeListeners() {
            // Listen for guards updates
            onSnapshot(collection(db, 'guards'), (snapshot) => {
                loadGuards();
            });
            
            // Listen for spots updates
            onSnapshot(query(collection(db, 'spots'), where('active', '==', true)), (snapshot) => {
                loadActiveSpots();
            });
        }
        
        // Generate random location near Belém for demo
        function generateRandomLocation() {
            const baseLat = -1.4558;
            const baseLng = -48.4902;
            const offset = 0.05;
            
            return {
                lat: baseLat + (Math.random() - 0.5) * offset,
                lng: baseLng + (Math.random() - 0.5) * offset
            };
        }
        
        // Update cards view
        function updateCardsView() {
            const container = document.getElementById('cardsView');
            
            if (guards.length === 0) {
                container.innerHTML = '<div class="empty-state">Nenhum guardador encontrado</div>';
                return;
            }
            
            container.innerHTML = guards.map(guard => `
                <div class="guard-card">
                    <div class="guard-header">
                        <div class="guard-avatar">${guard.name[0].toUpperCase()}</div>
                        <div class="guard-info">
                            <h3>${guard.name}</h3>
                            <div class="guard-rating">
                                ${'⭐'.repeat(Math.floor(guard.rating || 5))}
                                <span>${guard.rating || 5.0}</span>
                            </div>
                        </div>
                    </div>
                    <div class="guard-stats">
                        <div>
                            <div class="guard-stat-value">${guard.spotsToday || 0}</div>
                            <div class="guard-stat-label">Vagas Hoje</div>
                        </div>
                        <div>
                            <div class="guard-stat-value">R$ ${(guard.todayEarnings || 0).toFixed(2)}</div>
                            <div class="guard-stat-label">Ganhos Hoje</div>
                        </div>
                        <div>
                            <div class="guard-stat-value">${guard.area || 'N/A'}</div>
                            <div class="guard-stat-label">Área</div>
                        </div>
                    </div>
                    <div class="guard-actions">
                        <button class="btn btn-primary" onclick="viewGuardDetails('${guard.id}')">Ver Detalhes</button>
                        <button class="btn btn-secondary" onclick="showGuardQR('${guard.id}')">QR Code</button>
                    </div>
                </div>
            `).join('');
        }
        
        // Update table view
        function updateTableView() {
            const tbody = document.getElementById('guardsTableBody');
            
            if (guards.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Nenhum guardador encontrado</td></tr>';
                return;
            }
            
            tbody.innerHTML = guards.map(guard => `
                <tr>
                    <td>${guard.name}</td>
                    <td>${formatCPF(guard.cpf)}</td>
                    <td>${guard.area || 'N/A'}</td>
                    <td>
                        <span class="status-badge status-${guard.status}">
                            ${guard.status === 'busy' ? 'Ocupado' : 'Disponível'}
                        </span>
                    </td>
                    <td>${'⭐'.repeat(Math.floor(guard.rating || 5))} ${guard.rating || 5.0}</td>
                    <td>${guard.spotsToday || 0}</td>
                    <td>R$ ${(guard.todayEarnings || 0).toFixed(2)}</td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="viewGuardDetails('${guard.id}')">Detalhes</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Global functions
        window.toggleSidebar = () => {
            document.getElementById('sidebar').classList.toggle('collapsed');
        };
        
        window.approveAssociation = async (docId) => {
            try {
                // Get association data
                const pendingDoc = await getDoc(doc(db, 'associacoes_pendentes', docId));
                const data = pendingDoc.data();
                
                // Create association
                await addDoc(collection(db, 'associations'), {
                    ...data,
                    status: 'active',
                    approvedAt: serverTimestamp(),
                    approvedBy: currentUser.email,
                    guardsCount: 0
                });
                
                // Create user account for association
                // This would need Cloud Functions in production
                
                // Update pending status
                await updateDoc(doc(db, 'associacoes_pendentes', docId), {
                    status: 'aprovado'
                });
                
                alert('Associação aprovada com sucesso!');
                loadAdminDashboard();
            } catch (error) {
                alert('Erro ao aprovar associação: ' + error.message);
            }
        };
        
        window.rejectAssociation = async (docId) => {
            if (!confirm('Tem certeza que deseja rejeitar esta associação?')) return;
            
            try {
                await updateDoc(doc(db, 'associacoes_pendentes', docId), {
                    status: 'rejeitado',
                    rejectedAt: serverTimestamp(),
                    rejectedBy: currentUser.email
                });
                
                alert('Associação rejeitada');
                loadAdminDashboard();
            } catch (error) {
                alert('Erro ao rejeitar associação: ' + error.message);
            }
        };
        
        window.showGuardQR = (guardId) => {
            // This would show QR in a modal
            alert('QR Code do guardador: ' + guardId);
        };
        
        window.editGuard = (guardId) => {
            // This would open edit form
            alert('Editar guardador: ' + guardId);
        };
        
        window.printQRCode = () => {
            window.print();
        };
        
        window.logout = async () => {
            try {
                await signOut(auth);
                const currentPath = window.location.pathname;
                const basePath = currentPath.substring(0, currentPath.lastIndexOf('/'));
                window.location.href = basePath + '/index.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        };
        
        // Utility functions
        function formatCPF(cpf) {
            if (!cpf) return '';
            return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }
    </script>
</body>
</html>
